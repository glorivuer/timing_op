---

### **项目：Chrome 扩展程序 "Reoperator" 开发需求文档 (V2)**

#### **1. 核心愿景 (Vision)**

开发一款名为 **Reoperator** 的 Chrome 扩展程序。它是一个专注、高效的浏览器操作录制与回放工具，旨在通过常驻的 Side Panel 提供一个无缝的录制、保存、管理、回放和编辑自动化流程的体验。

#### **2. 功能模块详述 (Feature Modules)**

**模块一：主界面与录制流程 (Main UI & Recording Workflow)**

1.  **界面触发**: 点击 Chrome 工具栏的 Reoperator 图标，在当前页面右侧滑出 Side Panel。
2.  **录制启动**:
    *   Side Panel 核心按钮为 **"Start Recording"**。
    *   点击后，插件立即进入录制模式。Side Panel 界面更新，显示 **"Finish & Save"** 和 **"Cancel"** 按钮。
    *   同时，出现一个 **"定位器策略 (Selector Strategy)"** 下拉菜单，选项包含：`CSS Selector`, `ID`, `Name`, `Tag Name`, `Class Name`, `XPath`。用户在录制过程中可以随时切换，后续操作将采用新策略。
3.  **事件捕获 (核心录制逻辑)**:
    *   **范围**: 只记录主网页上的用户操作，忽略 Side Panel 上的操作。
    *   **捕获事件定义**:
        *   `Navigation`: 页面跳转或刷新 (`goto` URL)。作为流程的起始步骤。
        *   `Click`: 用户的左键单击事件。
        *   `Input/Change`: 这是一个复合事件，用于捕获：
            *   在 `<input>` 和 `<textarea>` 元素中的输入、修改、删除文本（基于 `change` 事件触发）。
            *   对 `contenteditable="true"` 元素的修改。
    *   **不包含的事件 (Out of Scope)**: `Hover`, `Scroll`, `Right Click` 以及任何形式的断言功能。
4.  **实时步骤显示 (Live Recording Steps)**:
    *   录制过程中，每个被捕获的操作（如 `Click`, `Input/Change`）及其与上一步骤之间的等待时间，会实时地显示在 Side Panel 的列表中。
    *   显示格式示例：`CLICK on button#login (waited 2.1s)`
5.  **录制结束**:
    *   **Finish & Save**: 点击后，弹出保存窗口。
    *   **Cancel**: 点击后，放弃本次录制，清空 "Live Recording Steps" 列表。
    *   **意外中断**: 若录制中途关闭网页或浏览器，未保存的记录将被丢弃。

**模块二：流程的保存与管理 (Flow Saving & Management)**

1.  **保存流程**:
    *   保存窗口要求输入流程名称，默认名为 `OperateFlow_[YYYYMMDD_HHmmss]`。
    *   流程名称必须唯一。
    *   流程数据（包括步骤、定位器、等待时间、输入值等）以 JSON 格式保存在 `chrome.storage.local`。
    *   **密码处理**: 录制密码字段时，按用户要求，将密码 **明文** 写入并保存。
2.  **流程列表与组织**:
    *   Side Panel 主界面下方，用列表展示所有已保存的流程。每行包含一个单选按钮和流程名称。
    *   **[新功能] 标签 (Tags)**:
        *   在保存流程的弹窗中，提供一个输入框，允许用户为该流程添加一个或多个标签（例如 `测试`, `数据录入`）。
        *   在流程列表上方，提供一个标签过滤栏或下拉菜单，用户可以选择一个或多个标签来筛选显示的流程。
3.  **数据交互**:
    *   **[新功能] 导入/导出 (Import/Export)**:
        *   在流程列表区域提供 **"Import"** 和 **"Export"** 按钮。
        *   **Export**: 允许用户将一个或多个选中的流程导出为一个 `.json` 文件进行备份或分享。
        *   **Import**: 允许用户选择一个符合格式的 `.json` 文件，将其中的流程导入到插件中。
4.  **流程操作**:
    *   在列表中选中一个流程后，下方的 **"Run Flow"**, **"Edit Flow"**, **"Delete"** 按钮被激活。

**模块三：流程回放 (Run Flow)**

1.  **启动回放**: 选中一个流程，点击 "Run Flow"，在一个新的 Chrome 标签页中开始执行。
2.  **执行过程**:
    *   严格按照保存的步骤、等待时间和操作值顺序执行。
    *   **[新功能] 视觉反馈**: 回放时，在网页上用高亮边框（如红色虚线框）实时标识出当前正在操作的元素。
3.  **[新功能] 失败处理与日志**:
    *   **失败机制**: 回放时，如果在一个预设的超时时间（例如 10 秒）内找不到目标元素，则该步骤执行失败，整个流程 **立即中止**。
    *   **日志记录**:
        *   每次回放结束后（无论成功或失败），生成一份执行日志。
        *   日志应包含：流程名称、开始/结束时间、最终状态（成功/失败）、每个步骤的执行情况（成功/失败）、若失败则记录失败的步骤和原因（如 "Element not found with selector: #id"）。
        *   提供一个 "查看日志" 的按钮或区域，让用户可以方便地查看历史回放记录。

**模块四：流程编辑 (Edit Flow)**

1.  **启动编辑**: 选中一个流程，点击 "Edit Flow"，打开一个新的 Chrome 标签页作为专属的编辑界面。
2.  **编辑界面**: 以清晰的列表或表格形式展示该流程的所有步骤。
3.  **[新功能] 核心编辑能力**:
    *   **步骤顺序调整**: 用户可以通过 **拖拽** 的方式，自由调整步骤的执行顺序。
    *   **增删步骤**:
        *   提供 "Add Step" 按钮，允许用户在任意位置手动插入一个新的步骤（如 Click, Input, Wait 等）。
        *   每个步骤旁边都有一个删除按钮，可以移除该步骤。
    *   **修改步骤参数**: 用户可以直接修改每个步骤的现有参数，如：
        *   等待时间 (Wait Time)
        *   定位器策略和值 (Selector)
        *   输入/修改的文本内容 (Value)
4.  **[新功能] 交互式选择器更新 (Interactive Selector Update)**:
    *   在每个需要定位元素的步骤旁边，提供一个 **"重选元素 (Re-select Element)"** 的靶心图标按钮。
    *   用户点击该按钮后，编辑界面会最小化或半透明，光标进入元素选择模式。
    *   用户在原始目标网页上点击一个新的元素，插件会自动捕获该元素的定位器，并更新到当前编辑的步骤中，极大地提升了维护效率。
5.  **保存与取消**: 编辑界面提供 "Save Changes" 和 "Cancel" 按钮，用于保存修改或放弃更改。
